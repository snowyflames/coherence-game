<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    
    <!-- Mobile Web App Capable Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050505">

    <!-- LINK TO MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <title>COHERENCE</title>
    <style>
        /* --- Fonts & Vars --- */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');

        :root {
            --bg: #050505;
            --wall: #eeeeee;
            --path: #000000;
            --player: #ffffff;
            --goal: #444444;
            --accent: #ffffff;
            --danger: #ff3333;
            --gold: #ffd700;
            --ui-bg: rgba(0, 0, 0, 0.95);
            --border: #333333;
            --sector-1: #4ff;
            --sector-2: #4f4;
            --sector-3: #ff4;
            --sector-4: #f80;
            --sector-5: #f44;
        }

        body {
            background-color: var(--bg);
            color: var(--wall);
            font-family: 'JetBrains Mono', monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* --- CRT Scanline Effect --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* --- INSTALLER LANDING PAGE --- */
        #installer-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            text-align: center;
            padding: 20px;
        }

        #installer-content h1 {
            font-size: 3rem;
            letter-spacing: -3px;
            margin-bottom: 0;
        }

        #installer-content p {
            color: #888;
            margin-bottom: 40px;
            font-size: 0.9rem;
        }

        .install-btn {
            background: var(--wall);
            color: var(--bg);
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            font-family: inherit;
            animation: pulse 2s infinite;
            display: none; /* Hidden until prompt is ready */
        }

        .ios-instructions {
            display: none;
            border: 1px dashed #444;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #aaa;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        /* --- GAME UI (Hidden by default) --- */
        #app-root {
            display: none; /* Only shown in App Mode */
            width: 100%;
            height: 100%;
        }

        /* Styles */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--ui-bg); z-index: 10; transition: opacity 0.3s; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .btn-group { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; }
        
        button { background: transparent; color: var(--wall); border: 2px solid var(--wall); padding: 15px; font-family: inherit; font-size: 1rem; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: all 0.1s; position: relative; overflow: hidden; }
        button:hover { background: var(--wall); color: var(--bg); transform: translateY(-2px); }
        button:disabled { opacity: 0.3; cursor: not-allowed; transform: none !important; border-color: #555; color: #555; }

        #level-select-container { width: 90%; max-width: 600px; height: 60%; overflow-y: auto; padding-right: 10px; scrollbar-width: thin; scrollbar-color: var(--wall) var(--bg); }
        .level-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        
        .level-btn { 
            padding: 10px 0; min-width: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
        }
        .level-btn .stars { font-size: 0.6rem; color: var(--gold); height: 10px; line-height: 10px; }
        .level-btn.locked { border-color: #333; color: #333; background: #111; }
        .level-btn.locked:hover { background: #111; color: #333; transform: none; box-shadow: none; }

        .sector-header { grid-column: 1 / -1; font-size: 1.2rem; font-weight: bold; margin-top: 20px; color: var(--accent); text-align: left; border-bottom: 1px dashed #444; }
        
        #game-header { position: absolute; top: 0; left: 0; width: 100%; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border); background: var(--bg); z-index: 5; box-sizing: border-box;}
        #game-timer { font-size: 1.2rem; color: var(--accent); font-variant-numeric: tabular-nums; }
        #hint-text { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        
        #maze-container { margin-top: 60px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; padding: 20px; gap: 15px; width: 100%; height: calc(100% - 60px); overflow: hidden; }
        .maze-wrapper { border: 2px solid var(--border); position: relative; touch-action: none; }
        .maze-wrapper.active-leader { border-color: var(--wall); box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); z-index: 2; }
        .maze-wrapper.shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        /* UPDATED MUTE BUTTON STYLES */
        #mute-btn { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            border: none; 
            background: transparent;
            color: var(--wall);
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
        }
        #mute-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #mute-btn:hover { opacity: 1; transform: scale(1.1); background: transparent; }

        .slider-container { margin: 20px 0; text-align: center; width: 100%; max-width: 300px; }
        input[type="range"] { width: 100%; margin-bottom: 10px; accent-color: var(--wall); }
        .how-to-content { max-width: 600px; text-align: left; padding: 20px; line-height: 1.6; font-size: 0.9rem; }
        .key-term { color: var(--accent); font-weight: bold; } .danger-term { color: var(--danger); font-weight: bold; }

        /* Result Screen Stars */
        #result-stars { font-size: 3rem; color: var(--gold); margin: 10px 0 20px 0; letter-spacing: 10px; }
        #result-time { font-size: 1.2rem; color: #888; margin-bottom: 20px; }

    </style>
</head>
<body>

    <div class="scanlines"></div>

    <!-- 1. INSTALLER SCREEN -->
    <div id="installer-screen">
        <div id="installer-content">
            <h1>COHERENCE</h1>
            <p>THE ALIGNMENT PROTOCOL</p>
            <button id="install-trigger" class="install-btn">INSTALL SYSTEM</button>
            <div id="ios-guide" class="ios-instructions">
                <p><strong>IOS DETECTED</strong></p>
                <p>1. Tap the Share Button <img src="https://img.icons8.com/ios-glyphs/30/ffffff/share-rounded.png" style="width:15px; vertical-align:middle"></p>
                <p>2. Select "Add to Home Screen"</p>
            </div>
            <p style="margin-top: 30px; font-size: 0.7rem;">
                <a href="#" onclick="PWA.forceStart()" style="color: #444; text-decoration: none;">...or execute in browser</a>
            </p>
        </div>
    </div>

    <!-- 2. THE GAME -->
    <div id="app-root">
        <!-- MAIN MENU -->
        <div id="screen-menu" class="screen">
            <!-- MUTE BUTTON MOVED HERE -->
            <button id="mute-btn" onclick="AudioSys.toggle()">
                <!-- SVG Icon inserted by JS -->
            </button>

            <h1>COHERENCE</h1>
            <h2>The Alignment Protocol</h2>
            <div class="btn-group">
                <button onclick="Game.showLevelSelect()">Campaign</button>
                <button onclick="Game.showCustomSetup()">Custom Simulation</button>
                <button onclick="Game.showHowTo()">How to Play</button>
            </div>
        </div>
        
        <!-- HOW TO PLAY -->
        <div id="screen-how-to" class="screen hidden">
            <h1>INSTRUCTIONS</h1>
            <div class="how-to-content">
                <p><span class="key-term">OBJECTIVE:</span> Guide all white squares (players) to their goals simultaneously.</p>
                <p><span class="key-term">CONTROLS:</span> Use <span class="key-term">Arrow Keys</span> or <span class="key-term">Swipe</span> on the screen.</p>
                <p><span class="key-term">MECHANICS:</span></p>
                <ul style="list-style-type: square;">
                    <li><strong>The Slide:</strong> Players don't move 1 step. They slide until they hit a wall.</li>
                    <li><strong>The Leader:</strong> Swipe a specific maze to make it the "Leader". All other mazes will try to move the exact same distance.</li>
                    <li><strong>Desync:</strong> If a follower hits a wall early, they stop. This creates chaos you must fix.</li>
                </ul>
                <p><span class="danger-term">WIN CONDITION:</span> All players must land on the goal on the EXACT SAME TURN.</p>
            </div>
            <button onclick="Game.showMenu()" style="margin-top: 20px">Back</button>
        </div>

        <!-- LEVEL SELECT -->
        <div id="screen-levels" class="screen hidden">
            <h1>SELECT SECTOR</h1>
            <div id="level-select-container">
                <div class="level-grid" id="level-grid"></div>
            </div>
            <button onclick="Game.showMenu()" style="margin-top: 20px">Back</button>
        </div>

        <!-- CUSTOM SETUP -->
        <div id="screen-custom" class="screen hidden">
            <h1>CUSTOM PROTOCOL</h1>
            <div class="slider-container">
                <label>MAZES: <span id="custom-val">4</span></label>
                <input type="range" id="custom-slider" min="2" max="9" value="4" oninput="document.getElementById('custom-val').innerText = this.value">
            </div>
            <div class="slider-container">
                <label>COMPLEXITY: <span id="diff-val">NORMAL</span></label>
                <input type="range" id="difficulty-slider" min="1" max="5" value="3" oninput="Game.updateDiffLabel(this.value)">
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button onclick="Game.startCustom()">INITIATE</button>
                <button onclick="Game.showMenu()">ABORT</button>
            </div>
        </div>

        <!-- WIN/LOSE OVERLAY -->
        <div id="screen-result" class="screen hidden" style="background: rgba(0,0,0,0.9);">
            <h1 id="result-title">SEQUENCE COMPLETE</h1>
            <div id="result-stars">â˜…â˜…â˜…</div>
            <div id="result-time">Time: 12.45s</div>
            <div class="btn-group">
                <button id="next-lvl-btn" onclick="Game.nextLevel()">NEXT LEVEL</button>
                <button onclick="Game.restartLevel()">RETRY</button>
                <button onclick="Game.showMenu()">MENU</button>
            </div>
        </div>

        <!-- IN-GAME UI -->
        <div id="game-ui" class="hidden">
            <div id="game-header">
                <button id="back-btn" onclick="Game.showMenu()">EXIT</button>
                <span id="level-info">LEVEL 1</span>
                <!-- RESTORED HINT TEXT -->
                <span id="hint-text">SWIPE A MAZE TO LEAD</span>
                <div id="game-timer">00.00</div>
            </div>
            <div id="maze-container"></div>
        </div>
    </div>

    <script>
        /* --- PWA INSTALLER --- */
        const PWA={deferredPrompt:null,init(){
            // Standard Service Worker Registration
            if('serviceWorker'in navigator){
                navigator.serviceWorker.register('./sw.js')
                    .then(()=>console.log('SW Registered'))
                    .catch((e)=>console.log('SW Failed:',e));
            }
            
            const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone===true;
            
            if(isStandalone){
                this.launchGame();
            }else{
                window.addEventListener('beforeinstallprompt',(e)=>{
                    e.preventDefault();
                    this.deferredPrompt=e;
                    const btn=document.getElementById('install-trigger');
                    btn.style.display='block';
                    btn.addEventListener('click',()=>this.triggerInstall());
                });

                const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;
                if(isIOS){
                    document.getElementById('install-trigger').style.display='none';
                    document.getElementById('ios-guide').style.display='block';
                }
            }
        },triggerInstall(){if(this.deferredPrompt){this.deferredPrompt.prompt();this.deferredPrompt.userChoice.then((r)=>{if(r.outcome==='accepted')this.deferredPrompt=null;});}},forceStart(){this.launchGame();},launchGame(){document.getElementById('installer-screen').style.display='none';document.getElementById('app-root').style.display='block';Game.init();document.body.addEventListener('click',()=>{if(!AudioSys.ctx)AudioSys.init();},{once:true});}};

        /* --- AUDIO ENGINE --- */
        const AudioSys={
            ctx:null,muted:false,bgmOsc:null,bgmGain:null,musicTimer:null,scale:[130.81,155.56,174.61,196.00,233.08,261.63],
            // SVG ICONS FOR MUTE BUTTON
            icons: {
                on: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>',
                off: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>'
            },
            init(){
                window.AudioContext=window.AudioContext||window.webkitAudioContext;this.ctx=new AudioContext();this.startBGM();
                this.updateIcon();
            },
            toggle(){
                this.muted=!this.muted;
                if(this.ctx){if(this.muted)this.ctx.suspend();else this.ctx.resume();}else{this.init();}
                this.updateIcon();
            },
            updateIcon(){
                const btn = document.getElementById('mute-btn');
                if(btn) btn.innerHTML = this.muted ? this.icons.off : this.icons.on;
            },
            playTone(freq,type,duration,vol=0.1,slide=false){if(this.muted||!this.ctx)return;const osc=this.ctx.createOscillator();const gain=this.ctx.createGain();osc.type=type;osc.frequency.setValueAtTime(freq,this.ctx.currentTime);if(slide)osc.frequency.exponentialRampToValueAtTime(freq*0.5,this.ctx.currentTime+duration);gain.gain.setValueAtTime(0,this.ctx.currentTime);gain.gain.linearRampToValueAtTime(vol,this.ctx.currentTime+0.02);gain.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+duration);osc.connect(gain);gain.connect(this.ctx.destination);osc.start();osc.stop(this.ctx.currentTime+duration);},playMove(){this.playTone(220,'triangle',0.2,0.05);},playWall(){this.playTone(100,'sawtooth',0.1,0.08,true);},playSlide(){this.playTone(440,'sine',0.4,0.02);},playWin(){if(this.muted||!this.ctx)return;[261.63,329.63,392.00,523.25].forEach((f,i)=>setTimeout(()=>this.playTone(f,'triangle',1.0,0.1),i*100));},playLose(){this.playTone(150,'sawtooth',0.5,0.2,true);setTimeout(()=>this.playTone(110,'sawtooth',0.5,0.2,true),200);},playClick(){this.playTone(800,'sine',0.05,0.1);},startBGM(){if(!this.ctx||this.bgmOsc)return;this.bgmOsc=this.ctx.createOscillator();this.bgmGain=this.ctx.createGain();this.bgmOsc.type='sine';this.bgmOsc.frequency.value=65.41;const lfo=this.ctx.createOscillator();lfo.type='sine';lfo.frequency.value=0.05;const lfoGain=this.ctx.createGain();lfoGain.gain.value=20;lfo.connect(this.bgmOsc.frequency);this.bgmOsc.connect(this.bgmGain);this.bgmGain.connect(this.ctx.destination);this.bgmGain.gain.value=0.05;this.bgmOsc.start();lfo.start();this.musicLoop();},musicLoop(){if(this.muted||!this.ctx){this.musicTimer=setTimeout(()=>this.musicLoop(),1000);return;}if(Math.random()>0.6){const note=this.scale[Math.floor(Math.random()*this.scale.length)];const freq=Math.random()>0.8?note*2:note;this.playTone(freq,'sine',2.0,0.03);}this.musicTimer=setTimeout(()=>this.musicLoop(),2000+Math.random()*3000);}
        };

        /* --- SAVE SYSTEM --- */
        const Storage = {
            key: 'coherence_save_v1',
            data: { unlocked: 1, stars: {} },
            load() {
                const raw = localStorage.getItem(this.key);
                if(raw) this.data = JSON.parse(raw);
            },
            save() {
                localStorage.setItem(this.key, JSON.stringify(this.data));
            },
            unlockLevel(lvl) {
                if(lvl > this.data.unlocked) this.data.unlocked = lvl;
                this.save();
            },
            setStars(lvl, count) {
                if(!this.data.stars[lvl] || count > this.data.stars[lvl]) {
                    this.data.stars[lvl] = count;
                    this.save();
                }
            },
            getStars(lvl) { return this.data.stars[lvl] || 0; }
        };

        /* --- VISUALS & LOGIC --- */
        class Particle { constructor(x,y,c,t='trail'){this.x=x;this.y=y;this.c=c;this.t=t;if(t==='spark'){this.s=Math.random()*5+2;this.vx=(Math.random()-0.5)*8;this.vy=(Math.random()-0.5)*8;this.l=1.0;this.d=0.08;}else{this.s=Math.random()*3+1;this.vx=(Math.random()-0.5)*1;this.vy=(Math.random()-0.5)*1;this.l=1.0;this.d=0.04;}}update(){this.x+=this.vx;this.y+=this.vy;this.l-=this.d;if(this.t==='spark')this.s*=0.9;}draw(ctx){ctx.globalAlpha=this.l;ctx.fillStyle=this.c;ctx.fillRect(this.x,this.y,this.s,this.s);ctx.globalAlpha=1.0;}}

        const Game = {
            CELL_SIZE: 0, COLS: 0, ROWS: 0, mazes: [], active: false, mode: 'menu', currentLevel: 1, winningDirection: null, levels: [], inputStart: null, inputCurrent: null, inputIndex: null,
            startTime: 0, timerInterval: null, currentParTime: 0,
            
            init() {
                Storage.load();
                this.generateLevels();
                this.setupLevelGrid();
                
                // Init Icon
                AudioSys.updateIcon();

                requestAnimationFrame(this.loop.bind(this));
                document.addEventListener('keydown', this.handleKey.bind(this));
                const c = document.getElementById('maze-container');
                c.addEventListener('touchstart', this.handleTouchStart.bind(this), {passive: false});
                c.addEventListener('touchmove', this.handleTouchMove.bind(this), {passive: false});
                c.addEventListener('touchend', this.handleTouchEnd.bind(this), {passive: false});
                c.addEventListener('mousedown', this.handleTouchStart.bind(this));
                window.addEventListener('mousemove', this.handleTouchMove.bind(this));
                window.addEventListener('mouseup', this.handleTouchEnd.bind(this));
                document.addEventListener('click', (e) => { if (e.target.closest('button') && !e.target.disabled) AudioSys.playClick(); });
            },
            generateLevels() {
                // Added par_base (seconds) to calculate stars
                for(let i=1;i<=20;i++) this.levels.push({m:2, s:11+(Math.floor((i-1)/5)*4), c:'SECTOR 1: GENESIS', col:'var(--sector-1)', par: 10 + i});
                for(let i=21;i<=40;i++) this.levels.push({m:3, s:15+(Math.floor((i-21)/5)*2), c:'SECTOR 2: EXPANSION', col:'var(--sector-2)', par: 15 + (i-20)*2});
                for(let i=41;i<=60;i++) this.levels.push({m:4+(i>50?1:0), s:19+(Math.floor((i-41)/10)*6), c:'SECTOR 3: CONVERGENCE', col:'var(--sector-3)', par: 30 + (i-40)*3});
                for(let i=61;i<=80;i++) this.levels.push({m:6+(i>70?1:0), s:25+(Math.floor((i-61)/10)*6), c:'SECTOR 4: ENTROPY', col:'var(--sector-4)', par: 45 + (i-60)*4});
                for(let i=81;i<=100;i++) this.levels.push({m:8+(i>90?1:0), s:31+(Math.floor((i-81)/10)*10), c:'SECTOR 5: EVENT HORIZON', col:'var(--sector-5)', par: 60 + (i-80)*5});
            },
            setupLevelGrid() {
                const grid = document.getElementById('level-grid'); grid.innerHTML = ''; let lastCategory = '';
                this.levels.forEach((lvl, i) => {
                    const levelNum = i + 1;
                    if(lvl.c !== lastCategory) { const h = document.createElement('div'); h.className = 'sector-header'; h.innerText = lvl.c; h.style.color = lvl.col; grid.appendChild(h); lastCategory = lvl.c; }
                    const btn = document.createElement('button'); 
                    btn.className = 'level-btn'; 
                    
                    // Lock Logic
                    if(levelNum > Storage.data.unlocked) {
                        btn.classList.add('locked');
                        btn.disabled = true;
                        btn.innerHTML = `<span>ðŸ”’</span><span style="font-size:0.8rem">${levelNum}</span>`;
                    } else {
                        btn.style.borderColor = lvl.col;
                        // Stars Logic
                        const stars = Storage.getStars(levelNum);
                        let starStr = '';
                        for(let s=0; s<3; s++) starStr += s < stars ? 'â˜…' : 'Â·';
                        btn.innerHTML = `<span>${levelNum}</span><span class="stars">${starStr}</span>`;
                        btn.onclick = () => this.startLevel(levelNum); 
                    }
                    grid.appendChild(btn);
                });
            },
            showScreen(id) { document.querySelectorAll('.screen, #game-ui').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); },
            showMenu() { this.active = false; clearInterval(this.timerInterval); this.showScreen('screen-menu'); AudioSys.startBGM(); this.setupLevelGrid(); }, // Refresh grid on menu return
            showLevelSelect() { this.showScreen('screen-levels'); },
            showCustomSetup() { this.showScreen('screen-custom'); },
            showHowTo() { this.showScreen('screen-how-to'); },
            updateDiffLabel(val) { const labels = ['TUTORIAL', 'EASY', 'NORMAL', 'HARD', 'NIGHTMARE']; document.getElementById('diff-val').innerText = labels[val - 1]; },
            startLevel(lvlNum) { this.mode = 'campaign'; this.currentLevel = lvlNum; const config = this.levels[lvlNum - 1]; this.currentParTime = config.par; this.startSession(config.m, config.s); },
            startCustom() { this.mode = 'custom'; const count = parseInt(document.getElementById('custom-slider').value); const diffVal = parseInt(document.getElementById('difficulty-slider').value); const sizes = [11, 15, 21, 31, 41]; this.currentParTime = 0; this.startSession(count, sizes[diffVal - 1]); },
            restartLevel() { if (this.mode === 'campaign') this.startLevel(this.currentLevel); else this.startCustom(); },
            nextLevel() { if (this.currentLevel < this.levels.length) this.startLevel(this.currentLevel + 1); else this.showMenu(); },
            
            startSession(count, size) {
                this.active = true; this.mazes = []; this.COLS = size; this.ROWS = size; this.inputStart = null;
                if (Math.random() < 0.5) { this.winningDirection = { dx: 1, dy: 0, label: 'RIGHT' }; } else { this.winningDirection = { dx: 0, dy: 1, label: 'DOWN' }; }
                const c = document.getElementById('maze-container'); c.innerHTML = '';
                const gridDim = Math.ceil(Math.sqrt(count)); const maxW = (window.innerWidth - 40) / gridDim; const maxH = (window.innerHeight - 100) / gridDim; const minDim = Math.min(maxW, maxH); this.CELL_SIZE = Math.floor(minDim / size); if(this.CELL_SIZE < 4) this.CELL_SIZE = 4; 
                for(let i=0; i<count; i++) this.createMaze(i);
                document.getElementById('level-info').innerText = this.mode === 'campaign' ? `LEVEL ${this.currentLevel}` : 'CUSTOM RUN';
                document.getElementById('next-lvl-btn').style.display = this.mode === 'campaign' ? 'block' : 'none';
                this.showScreen('game-ui');
                
                // Start Timer
                this.startTime = Date.now();
                this.updateTimerDisplay();
                if(this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => this.updateTimerDisplay(), 100);
            },
            updateTimerDisplay() {
                const elapsed = (Date.now() - this.startTime) / 1000;
                document.getElementById('game-timer').innerText = elapsed.toFixed(2);
            },
            createMaze(index) {
                const c = document.getElementById('maze-container'); const canvas = document.createElement('canvas'); canvas.width = this.COLS * this.CELL_SIZE; canvas.height = this.ROWS * this.CELL_SIZE;
                const wrapper = document.createElement('div'); wrapper.className = 'maze-wrapper'; wrapper.dataset.index = index; wrapper.appendChild(canvas); c.appendChild(wrapper);
                this.mazes.push({ id: index, ctx: canvas.getContext('2d'), grid: this.generateGrid(this.COLS, this.ROWS), player: { x: 1, y: 1 }, goal: { x: this.COLS - 2, y: this.ROWS - 2 }, particles: [], wrapper: wrapper, finished: false, flash: 0 });
            },
            generateGrid(cols, rows) {
                let grid = Array(rows).fill(null).map(() => Array(cols).fill(1)); let stack = [{x:1, y:1}]; grid[1][1] = 0;
                const goalX = cols - 2; const goalY = rows - 2; let validEntryX = this.winningDirection.dx === 1 ? goalX - 2 : goalX; let validEntryY = this.winningDirection.dx === 1 ? goalY : goalY - 2;
                while(stack.length > 0) {
                    let cur = stack[stack.length-1]; let neighbors = [];
                    [[0,-2],[0,2],[-2,0],[2,0]].forEach(d => { let nx = cur.x + d[0]; let ny = cur.y + d[1]; if(nx>0 && nx<cols-1 && ny>0 && ny<rows-1 && grid[ny][nx]===1) { if (nx === goalX && ny === goalY) { if (cur.x !== validEntryX || cur.y !== validEntryY) return; } neighbors.push({x:nx, y:ny, dx:d[0]/2, dy:d[1]/2}); } });
                    if(neighbors.length) { let n = neighbors[Math.floor(Math.random()*neighbors.length)]; grid[cur.y + n.dy][cur.x + n.dx] = 0; grid[n.y][n.x] = 0; stack.push({x:n.x, y:n.y}); } else { stack.pop(); }
                } return grid;
            },
            loop() { if(this.active) { const time = Date.now(); this.mazes.forEach(maze => { this.drawMaze(maze, time); this.updateParticles(maze); }); } requestAnimationFrame(this.loop.bind(this)); },
            updateParticles(maze) { for(let i=maze.particles.length-1; i>=0; i--) { let p = maze.particles[i]; p.update(); if(p.life <= 0) maze.particles.splice(i, 1); } },
            drawMaze(maze, time) {
                const ctx = maze.ctx; ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                if (maze.flash > 0) { ctx.fillStyle = `rgba(255, 50, 50, ${maze.flash})`; ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height); maze.flash -= 0.1; }
                ctx.fillStyle = '#eeeeee'; for(let y=0; y<this.ROWS; y++) { for(let x=0; x<this.COLS; x++) { if(maze.grid[y][x] === 1) { ctx.fillRect(x*this.CELL_SIZE, y*this.CELL_SIZE, this.CELL_SIZE+1, this.CELL_SIZE+1); } } }
                const pulse = 0.5 + 0.5 * Math.sin(time / 300); ctx.fillStyle = maze.finished ? '#fff' : `rgba(100, 100, 100, ${0.5 + pulse * 0.5})`; const gx = maze.goal.x * this.CELL_SIZE; const gy = maze.goal.y * this.CELL_SIZE; ctx.fillRect(gx + 2, gy + 2, this.CELL_SIZE - 4, this.CELL_SIZE - 4);
                if (!maze.finished) { ctx.strokeStyle = `rgba(255, 255, 255, ${0.8 - pulse * 0.5})`; ctx.lineWidth = 1; const offset = pulse * 3; ctx.strokeRect(gx - offset, gy - offset, this.CELL_SIZE + offset*2, this.CELL_SIZE + offset*2); }
                maze.particles.forEach(p => p.draw(ctx));
                ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = "white"; ctx.fillRect(maze.player.x*this.CELL_SIZE + 1, maze.player.y*this.CELL_SIZE + 1, this.CELL_SIZE - 2, this.CELL_SIZE - 2); ctx.shadowBlur = 0;
                if (this.inputStart && this.inputCurrent && maze.id === this.inputIndex) { ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)'; ctx.lineWidth = 2; ctx.beginPath(); const cx = ctx.canvas.width / 2; const cy = ctx.canvas.height / 2; const dx = this.inputCurrent.x - this.inputStart.x; const dy = this.inputCurrent.y - this.inputStart.y; ctx.moveTo(cx - 20, cy); ctx.lineTo(cx + 20, cy); ctx.moveTo(cx, cy - 20); ctx.lineTo(cx, cy + 20); ctx.moveTo(cx, cy); ctx.lineTo(cx + dx, cy + dy); ctx.stroke(); }
            },
            spawnParticles(maze, x, y, color, count=5, type='trail') { const px = x * this.CELL_SIZE + this.CELL_SIZE/2; const py = y * this.CELL_SIZE + this.CELL_SIZE/2; for(let i=0; i<count; i++) { maze.particles.push(new Particle(px, py, color, type)); } },
            handleInput(dx, dy, leaderIndex) {
                if (!this.active) return; leaderIndex = leaderIndex !== undefined ? leaderIndex : 0; const leader = this.mazes[leaderIndex];
                this.mazes.forEach(m => m.wrapper.classList.remove('active-leader')); leader.wrapper.classList.add('active-leader'); setTimeout(() => leader.wrapper.classList.remove('active-leader'), 300);
                let steps = 0; let tx = leader.player.x; let ty = leader.player.y;
                while(true) { if (tx+dx < 0 || tx+dx >= this.COLS || ty+dy < 0 || ty+dy >= this.ROWS) break; if (leader.grid[ty+dy][tx+dx] === 1) break; tx += dx; ty += dy; steps++; }
                if (steps === 0) { leader.wrapper.classList.add('shake'); setTimeout(()=>leader.wrapper.classList.remove('shake'), 300); leader.flash = 0.5; AudioSys.playWall(); this.spawnParticles(leader, leader.player.x + dx/2, leader.player.y + dy/2, '#ff5555', 8, 'spark'); return; }
                AudioSys.playSlide(); let onGoalCount = 0;
                this.mazes.forEach(maze => { let moved = false; for(let i=0; i<steps; i++) { const nx = maze.player.x + dx; const ny = maze.player.y + dy; if (nx >= 0 && nx < this.COLS && ny >= 0 && ny < this.ROWS && maze.grid[ny][nx] === 0) { maze.player.x = nx; maze.player.y = ny; moved = true; if(Math.random()>0.6) this.spawnParticles(maze, nx, ny, '#555', 1, 'trail'); } else { if(i > 0) { maze.flash = 0.3; this.spawnParticles(maze, maze.player.x, maze.player.y, '#fff', 5, 'spark'); } break; } } if (maze.player.x === maze.goal.x && maze.player.y === maze.goal.y) { onGoalCount++; maze.finished = true; } else { maze.finished = false; } });
                if (onGoalCount > 0) this.checkWin(onGoalCount);
            },
            checkWin(count) { 
                this.active = false; 
                clearInterval(this.timerInterval);
                const title = document.getElementById('result-title'); 
                const screen = document.getElementById('screen-result'); 
                screen.classList.remove('hidden'); 
                
                if(count === this.mazes.length) { 
                    title.innerText = "SYNCHRONIZED"; 
                    title.style.color = "#fff"; 
                    AudioSys.playWin(); 
                    this.mazes.forEach(m => this.spawnParticles(m, m.goal.x, m.goal.y, '#fff', 30, 'spark')); 
                    
                    // Time & Stars Logic
                    const elapsed = (Date.now() - this.startTime) / 1000;
                    document.getElementById('result-time').innerText = `TIME: ${elapsed.toFixed(2)}s`;
                    
                    let stars = 0;
                    if (this.mode === 'campaign') {
                        // Unlock next level
                        Storage.unlockLevel(this.currentLevel + 1);
                        
                        // Calculate Stars (Simple logic: Beat par time)
                        // 3 stars = < Par Time
                        // 2 stars = < Par Time * 1.5
                        // 1 star = Completed
                        if (elapsed <= this.currentParTime) stars = 3;
                        else if (elapsed <= this.currentParTime * 1.5) stars = 2;
                        else stars = 1;
                        
                        Storage.setStars(this.currentLevel, stars);
                    } else {
                        stars = 1; // Custom mode just gets 1 star for finishing
                    }
                    
                    const starStr = 'â˜…'.repeat(stars) + 'â˜†'.repeat(3-stars);
                    document.getElementById('result-stars').innerText = starStr;
                    document.getElementById('result-stars').style.display = 'block';

                } else { 
                    title.innerText = "SYNC FAILED"; 
                    title.style.color = "#ff3333"; 
                    AudioSys.playLose();
                    document.getElementById('result-time').innerText = "";
                    document.getElementById('result-stars').style.display = 'none';
                } 
            },
            handleKey(e) { if(!this.active) return; if(e.key === 'ArrowUp' || e.key === 'w') this.handleInput(0, -1); if(e.key === 'ArrowDown' || e.key === 's') this.handleInput(0, 1); if(e.key === 'ArrowLeft' || e.key === 'a') this.handleInput(-1, 0); if(e.key === 'ArrowRight' || e.key === 'd') this.handleInput(1, 0); },
            handleTouchStart(e) { if(!this.active) return; const wrapper = e.target.closest('.maze-wrapper'); if(!wrapper) return; this.inputIndex = parseInt(wrapper.dataset.index); const evt = e.touches ? e.touches[0] : e; this.inputStart = { x: evt.clientX, y: evt.clientY }; this.inputCurrent = { x: evt.clientX, y: evt.clientY }; },
            handleTouchMove(e) { if (!this.inputStart || !this.active) return; const evt = e.touches ? e.touches[0] : e; this.inputCurrent = { x: evt.clientX, y: evt.clientY }; },
            handleTouchEnd(e) { if(!this.inputStart) return; const evt = e.changedTouches ? e.changedTouches[0] : e; const dx = evt.clientX - this.inputStart.x; const dy = evt.clientY - this.inputStart.y; if(Math.abs(dx) > 30 || Math.abs(dy) > 30) { if(Math.abs(dx) > Math.abs(dy)) { this.handleInput(dx>0?1:-1, 0, this.inputIndex); } else { this.handleInput(0, dy>0?1:-1, this.inputIndex); } } this.inputStart = null; this.inputCurrent = null; this.inputIndex = null; }
        };

        // --- BOOT SEQUENCE ---
        window.onload = () => {
            PWA.init();
        };

    </script>
</body>
</html>
